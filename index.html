<!DOCTYPE html>
<html>

<head>
	<title>canada-cpi</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		html { font-family: 'Montserrat',sans-serif; font-size: 12px; font-weight: 500; letter-spacing: 0; }
		body { color: hsl(0, 0%, 30%); background-color: hsl(0, 0%, 95%); width: 100%; }
		a { text-decoration: none; }
		#jsonContainer { display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-start; gap: 0; flex: 0 0 25%; width:100%; }
		.jsonTable { display: flex; flex-wrap: wrap; width: 100%; max-width: 400px; padding: 10px 20px; }
		@media (max-width: 1600px) { .table-container { flex: 0 0 33.33%; max-width: 33.33%; } }
		@media (max-width: 1200px) { .table-container { flex: 0 0 50%; max-width: 50%; } }
		@media (max-width: 800px) { .table-container { flex: 0 0 100%; max-width: 100%; } }
		.column-left { text-align: left; width: 70%; align-self: flex-end; }
		.column-right { text-align: right; width: 10%; align-self: flex-end; }
		.table-header { display: flex; flex-wrap: wrap; gap: 0; border-bottom: 2px solid hsl(0, 0%, 50%); width: 100%; }
		.table-row { display: flex; flex-wrap: wrap; gap: 0; width: 100%; }
    .table-row-group { display: flex; flex-wrap: wrap; gap: 0; border-bottom: 1px solid hsl(0, 0%, 80%); width: 100%; padding: 10px 0 0 0; }
		.hidden { display: none; }
    .first-child { border-top: 1px solid hsl(0, 0%, 50%); }
    .last-child { border-bottom: 1px solid hsl(0, 0%, 50%); }
    [data-level="0"] { background-color: hsl(0, 0%, 95%); }
    [data-level="1"] { background-color: hsl(0, 0%, 95%); cursor: pointer; }
    [data-level="2"] { background-color: hsl(0, 0%, 90%); cursor: pointer; }
    [data-level="3"] { background-color: hsl(0, 0%, 85%); }
	</style>
</head>

<body>

	<div class="container">
		<div id="status"></div>
		<div id="jsonContainer"></div>
	</div>

	<script>
const tableId = '18100004';
const provinces = [
    "canada", "british_columbia", "alberta", "saskatchewan", "manitoba", "ontario",
    "quebec", "nova_scotia", "new_brunswick", "prince_edward_island",
    "newfoundland_and_labrador", "whitehorse", "yellowknife", "iqaluit"
];
const levels = [0,1,2,3];
const jsonData = {};

async function fetchCPI() {
    const jsonContainer = document.getElementById('jsonContainer');

    for (let p of provinces) {
        const fileUrl = `https://raw.githubusercontent.com/jamiefletcher/canada-cpi/refs/heads/main/data/${tableId}/${p}.json`;
        const response = await fetch(fileUrl);
        const data = await response.json();
        const jsonTable = document.createElement('div');
		jsonTable.classList.add('jsonTable');
		let html = '';

		jsonTable.innerHTML = `
            <div class="table-header">
                <div class="column-left">${data.geography}</div>
                <div class="column-right">CPI</div>
                <div class="column-right">M%</div>
                <div class="column-right">Y%</div>
			</div>
				`;

levels.forEach(level => {
  data.data
    .filter(item => item.level === level)  // Filter by current level
	.forEach(item => {
      const categoryName = item.category === 'All-items' ? 'Total' : item.category;
      const cpi = item.values[12];
      const yoy = (item.values[12] - item.values[0]).toFixed(1);
      const yoySigned = yoy > 0 ? `+${yoy}` : `${yoy}`;
      const mom = (item.values[12] - item.values[11]).toFixed(1);
      const momSigned = mom > 0 ? `+${mom}` : `${mom}`;
      const id = `${p}-${item.catId[0]}`;

      // Generate HTML for the table row for the current level
      let html = `
        <div class="table-row-group" id="${id}" data-level="${level}" onclick="toggleChildren('${id}')">
          <div class="column-left">${categoryName}</div>
          <div class="column-right">${cpi}</div>
          <div class="column-right">${momSigned}</div>
          <div class="column-right">${yoySigned}</div>
        </div>
		`;

		item.children.flat().forEach(child => {
            html += `<div class="hidden table-row" id="${p}-${child}" data-parentid="${id}"></div>`;
        });

		if (item.level <= 1) {
			jsonTable.innerHTML += html;
			jsonContainer.appendChild(jsonTable);
		} else {
			// Find the div with id = catId for the current level
			const parentDiv = document.getElementById(id);
			if (parentDiv) {
                parentDiv.innerHTML += html;
            }
		}
	});
});



	};
};

function toggleChildren(id) {
  const children = document.querySelectorAll(`[data-parentid='${id}']`);

  children.forEach((child, index) => {
    const isHidden = child.classList.contains('hidden');

    if (isHidden) {
      child.classList.remove('hidden');
      if (index === 0) {
        child.classList.add('first-child');
      }
      if (index === children.length - 1) {
        child.classList.add('last-child');
      }
    } else {
      child.classList.add('hidden');
      child.classList.remove('first-child', 'last-child'); // Remove styles when hidden
    }
  });
}

fetchCPI();

	</script>
</body>

</html>